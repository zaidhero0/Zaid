name: Game Server Setup, User Creation, and Backups

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering via GitHub UI
  schedule:
    - cron: '0 */6 * * *'  # Run backup every 6 hours

jobs:
  setup-vps-and-backup:
    runs-on: windows-latest  # Use a Windows environment (Windows Server)
    env:
      GAME_SERVER_DIR: C:\game-server
      BACKUP_DIR: C:\backups
      GAME_PORT: 27015
      GAME_USERNAME: "GameUser"
      GAME_PASSWORD: "Aa1!2345"

    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    # Step 1: Install Git (Chocolatey or Manual)
    - name: Install Git (Chocolatey or Manual)
      run: |
        try {
          Write-Host "Installing Git via Chocolatey"
          choco install git -y
        } catch {
          Write-Host "Chocolatey Git installation failed, attempting manual installation."
          # Manually download and install Git
          Invoke-WebRequest -Uri "https://github.com/git-for-windows/git/releases/download/v2.52.0.windows.1/MinGit-2.52.0-64-bit.zip" -OutFile "git.zip"
          Expand-Archive -Path "git.zip" -DestinationPath "C:\Program Files\Git"
          # Add Git to the PATH environment variable
          $env:PATH += ";C:\Program Files\Git\cmd"
        }

    # Step 2: Check if NVIDIA Drivers are installed, if not, install them
    - name: Check and Install NVIDIA Drivers
      run: |
        try {
          # Check if nvidia-smi is available
          $nvidiaStatus = nvidia-smi
          Write-Host "NVIDIA Driver is already installed."
        } catch {
          Write-Host "NVIDIA Driver not found. Installing NVIDIA Drivers..."
          # Download NVIDIA driver installer
          Invoke-WebRequest -Uri "https://www.nvidia.com/Download/index.aspx" -OutFile "nvidia-driver.exe"
          Start-Process -FilePath "nvidia-driver.exe" -ArgumentList "/quiet /install" -Wait
          Write-Host "NVIDIA Drivers installed successfully."
        }

    # Step 3: Install CUDA (Optional, if needed for GPU acceleration)
    - name: Install CUDA (Optional)
      run: |
        try {
          Write-Host "Checking if CUDA is already installed"
          # Check if CUDA is already installed (optional)
          $cudaVersion = Get-Command "nvcc" -ErrorAction SilentlyContinue
          if ($cudaVersion) {
            Write-Host "CUDA is already installed."
          } else {
            Write-Host "Installing CUDA Toolkit..."
            Invoke-WebRequest -Uri "https://developer.download.nvidia.com/compute/cuda/11.2.0/local_installers/cuda_11.2.0_460.27.04_windows.exe" -OutFile "cuda-installer.exe"
            Start-Process -FilePath "cuda-installer.exe" -ArgumentList "/quiet /install" -Wait
            Write-Host "CUDA Toolkit installed successfully."
          }
        } catch {
          Write-Host "Error occurred during CUDA installation. Skipping CUDA installation."
        }

    # Step 4: Create User and Set Password
    - name: Create User and Set Password
      run: |
        Write-Host "Creating user $env:GAME_USERNAME"
        $userName = $env:GAME_USERNAME
        $password = ConvertTo-SecureString $env:GAME_PASSWORD -AsPlainText -Force
        New-LocalUser -Name $userName -Password $password -FullName "Game Server User" -Description "User for running game server"
        Add-LocalGroupMember -Group "Administrators" -Member $userName  # Add user to Admin group
        Write-Host "User $env:GAME_USERNAME created successfully."

    # Step 5: Install and Start Game Server (Replace with your actual server setup)
    - name: Install Game Server
      run: |
        Write-Host "Cloning and installing the game server..."
        git clone https://github.com/your-org/your-game-server.git $env:GAME_SERVER_DIR
        cd $env:GAME_SERVER_DIR
        .\install-server.ps1  # Replace with the actual script to install your game server
        .\start-server.ps1 --port $env:GAME_PORT --gpu true --cpu auto
        Write-Host "Game server installed and started successfully."

    # Step 6: Optimize Server Performance
    - name: Optimize Server Performance
      run: |
        Write-Host "Optimizing server performance"
        # Adjust power settings for better performance
        powercfg -change -standby-timeout-ac 0
        powercfg -change -monitor-timeout-ac 0
        powercfg -change -disk-timeout-ac 0
        Write-Host "Server performance optimized."

    # Step 7: Backup Game Server Data
    - name: Save and Backup Data
      run: |
        Write-Host "Saving and backing up game server data"
        Compress-Archive -Path "$env:GAME_SERVER_DIR\*" -DestinationPath "$env:BACKUP_DIR\backup_$(Get-Date -Format 'yyyyMMddHHmmss').zip"
        # Optionally, upload the backup to cloud storage (AWS, etc.)
        aws s3 cp "$env:BACKUP_DIR\backup_$(Get-Date -Format 'yyyyMMddHHmmss').zip" s3://your-backup-bucket/
        Write-Host "Backup completed."

    # Step 8: Get VPS External IP Address
    - name: Get VPS External IP Address
      run: |
        Write-Host "Fetching external IP address..."
        $VPS_IP = (Invoke-RestMethod -Uri "http://ifconfig.me").Trim()
        Write-Host "VPS External IP Address: $VPS_IP"

    # Step 9: Display Connection Credentials
    - name: Display Connection Credentials
      run: |
        Write-Host "Displaying connection credentials"
        Write-Host "Username: $env:GAME_USERNAME"
        Write-Host "Password: $env:GAME_PASSWORD"
        Write-Host "IP Address: $VPS_IP"
        # Optionally, save to a file or send via email/Slack
        Set-Content -Path "$env:BACKUP_DIR\connection_info.txt" -Value "Game Server Connection Info"
        Add-Content -Path "$env:BACKUP_DIR\connection_info.txt" -Value "Username: $env:GAME_USERNAME"
        Add-Content -Path "$env:BACKUP_DIR\connection_info.txt" -Value "Password: $env:GAME_PASSWORD"
        Add-Content -Path "$env:BACKUP_DIR\connection_info.txt" -Value "IP Address: $VPS_IP"
        Get-Content -Path "$env:BACKUP_DIR\connection_info.txt"

    # Step 10: Check CPU Usage and Reboot if Necessary
    - name: Check and Reboot (if necessary)
      run: |
        Write-Host "Checking CPU usage..."
        $cpuUsage = (Get-WmiObject win32_processor | Select-Object -First 1).LoadPercentage
        if ($cpuUsage -gt 90) {
          Write-Host "High CPU usage detected, restarting server..."
          Restart-Computer
        }

    # Step 11: Send Completion Notification (Optional)
    - name: Send Completion Notification
      run: |
        Write-Host "Sending completion notification"
        curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"Game server setup, user creation, and backup completed successfully!"}' \
          https://hooks.slack.com/services/your/slack/webhoo

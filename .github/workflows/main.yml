name: GPU VPS on GitHub Actions

on:
  workflow_dispatch:

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          echo "ğŸ§¹ Freeing disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
          echo "âœ… Space freed"

      - name: Install Desktop Environment
        run: |
          echo "ğŸ–¥ï¸ Installing XFCE desktop..."
          sudo apt-get update
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get install -y xfce4 xfce4-goodies
          echo "âœ… Desktop installed"

      - name: Install VNC Server
        run: |
          echo "ğŸ”Œ Installing VNC..."
          sudo apt-get install -y tigervnc-standalone-server
          echo "âœ… VNC installed"

      - name: Install noVNC
        run: |
          echo "ğŸŒ Installing noVNC..."
          sudo apt-get install -y novnc python3-websockify
          echo "âœ… noVNC installed"

      - name: Setup VNC
        run: |
          echo "âš™ï¸ Configuring VNC..."
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          exec startxfce4
          EOF
          
          chmod +x ~/.vnc/xstartup
          echo "âœ… VNC configured (password: password)"

      - name: Start VNC Server
        run: |
          echo "â–¶ï¸ Starting VNC..."
          vncserver :1 -geometry 1920x1080 -depth 24 -localhost no
          sleep 3
          echo "âœ… VNC running on :5901"

      - name: Start noVNC
        run: |
          echo "ğŸŒ Starting noVNC..."
          /usr/share/novnc/utils/novnc_proxy --vnc localhost:5901 --listen 6080 &
          sleep 3
          echo "âœ… noVNC running on :6080"

      - name: Install ngrok
        run: |
          echo "ğŸ“¡ Installing ngrok..."
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar xvzf ngrok-v3-stable-linux-amd64.tgz
          sudo mv ngrok /usr/local/bin/
          echo "âœ… ngrok installed"

      - name: Setup ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          if [ -z "$NGROK_TOKEN" ]; then
            echo "âŒ ERROR: NGROK_TOKEN secret not set!"
            echo ""
            echo "ğŸ“ How to fix:"
            echo "1. Go to https://ngrok.com and sign up (FREE)"
            echo "2. Get your token from: https://dashboard.ngrok.com/get-started/your-authtoken"
            echo "3. Go to your GitHub repo â†’ Settings â†’ Secrets â†’ Actions"
            echo "4. Click 'New repository secret'"
            echo "5. Name: NGROK_TOKEN"
            echo "6. Value: [paste your ngrok token]"
            echo "7. Run this workflow again"
            echo ""
            exit 1
          fi
          
          echo "ğŸ”‘ Configuring ngrok..."
          ngrok config add-authtoken $NGROK_TOKEN
          echo "âœ… ngrok configured"

      - name: Start ngrok Tunnel
        run: |
          echo "ğŸš‡ Starting ngrok tunnel..."
          ngrok http 6080 --log=stdout > ngrok.log &
          sleep 10
          
          # Get public URL
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
          
          if [ -z "$NGROK_URL" ]; then
            echo "âŒ Failed to get ngrok URL"
            cat ngrok.log
            exit 1
          fi
          
          echo "âœ… Tunnel created!"
          echo "$NGROK_URL" > ngrok_url.txt

      - name: Install Gaming Tools
        run: |
          echo "ğŸ® Installing gaming tools..."
          sudo apt-get install -y firefox
          
          # Install Wine for Windows apps
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y wine64 wine32
          
          echo "âœ… Gaming tools installed"

      - name: Display Connection Info
        run: |
          NGROK_URL=$(cat ngrok_url.txt)
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GPU VPS IS RUNNING ON GITHUB ACTIONS!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Access your VPS here:"
          echo "   $NGROK_URL/vnc.html"
          echo ""
          echo "ğŸ”‘ Password: password"
          echo ""
          echo "ğŸ“Š System Info:"
          echo "   OS: Ubuntu $(lsb_release -rs)"
          echo "   CPU: $(nproc) cores"
          echo "   RAM: $(free -h | grep Mem | awk '{print $2}')"
          echo "   Disk: $(df -h / | tail -1 | awk '{print $4}') free"
          echo ""
          echo "â±ï¸ Session will run for 6 hours"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: Keep Session Alive
        run: |
          echo "ğŸ”„ Keeping session alive..."
          echo "Press Ctrl+C in the Actions log to stop"
          echo ""
          
          # Keep alive for 6 hours
          for i in {1..360}; do
            echo "â° Session active: $i minutes"
            sleep 60
          done
          
          echo ""
          echo "â¹ï¸ Session ended after 6 hours"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          vncserver -kill :1 || true
          pkill ngrok || true
          echo "âœ… Cleanup complete"

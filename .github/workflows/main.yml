name: "Direct-Access RDP VPS"

on:
  workflow_dispatch: # Allows you to click 'Run' manually

jobs:
  build-vps:
    runs-on: self-hosted # REQUIRED: Your PC must be linked as a runner
    timeout-minutes: 525600

    steps:
      - name: "1. Enable Remote Desktop (Port 3389)"
        shell: cmd
        run: |
          :: Enable RDP in Registry
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          :: Disable NLA for easier connection
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          :: Open Port 3389 in Firewall
          netsh advfirewall firewall add rule name="Allow-RDP" dir=in action=allow protocol=TCP localport=3389

      - name: "2. Create VPS User Credentials"
        shell: cmd
        run: |
          :: Create User 'VPS_User' with Password 'Aa1!2345'
          net user VPS_User Aa1!2345 /add /expires:never
          net localgroup Administrators VPS_User /add
          net localgroup "Remote Desktop Users" VPS_User /add

      - name: "3. Generate Connection IP and Port"
        shell: powershell
        run: |
          $tsPath = "C:\Program Files\Tailscale\tailscale.exe"
          if (Test-Path $tsPath) {
              $ip = & $tsPath ip -4
              Write-Host "**************************************************"
              Write-Host "CONNECT TO YOUR VPS AT THIS ADDRESS:"
              Write-Host "$($ip):3389"
              Write-Host "**************************************************"
              Write-Host "User: VPS_User"
              Write-Host "Pass: Aa1!2345"
          } else {
              Write-Host "Error: Tailscale is not installed on this PC."
          }

      - name: "4. Keep VPS Alive (Infinite Loop)"
        shell: powershell
        run: |
          Write-Host "VPS is now active. You can close the GitHub tab but do not stop the action."
          while ($true) {
              Start-Sleep -Seconds 600
              Write-Host "[$(Get-Date)] VPS Heartbeat: Online"
          }

name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update and install dependencies
        run: |
          sudo apt update
          sudo apt install -y xrdp wget net-tools snapd

      - name: Install Tailscale via Snap
        run: |
          sudo snap install tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID

      - name: Create RDP User with Guaranteed Password
        run: |
          username="RDP"
          password="Aa1!2345"
          sudo useradd -m -s /bin/bash $username
          echo "$username:$password" | sudo chpasswd
          sudo usermod -aG sudo $username
          sudo usermod -aG ssl-cert $username
          echo "User '$username' created and added to sudo and ssl-cert groups."

      - name: Enable XRDP
        run: |
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          echo "XRDP enabled and started."

      - name: Verify Tailscale Connection
        run: |
          ts_ip=$(tailscale ip -4)
          echo "Tailscale IP: $ts_ip"

      - name: Verify RDP Accessibility
        run: |
          ts_ip=$(tailscale ip -4)
          echo "Checking RDP connection to $ts_ip..."
          nc -zv $ts_ip 3389
          if [ $? -ne 0 ]; then
            echo "RDP connection failed on $ts_ip:3389"
            exit 1
          else
            echo "RDP connection successful on $ts_ip:3389"
          fi

      - name: Maintain Connection
        run: |
          echo "RDP Access Setup Complete!"
          while true; do
            echo "Maintaining RDP Connection on Ubuntu"
            sleep 300
          done

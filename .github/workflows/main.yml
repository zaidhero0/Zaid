name: "üí† ULTIMATE LIFETIME GAMING VPS ORCHESTRATOR"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *' # High-frequency heartbeat every 3 hours

jobs:
  maintenance:
    name: "Sync, Shield & Deploy"
    runs-on: ubuntu-latest
    steps:
      - name: "Connecting to Infrastructure"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- 1. KERNEL HARDENING & NETWORK SHIELDING ---
            # Maximize TCP window size for gaming and 1Gbps+ throughput
            sudo sysctl -w net.ipv4.tcp_window_scaling=1
            sudo sysctl -w net.core.rmem_max=16777216
            sudo sysctl -w net.core.wmem_max=16777216
            sudo sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
            sudo sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"
            sudo sysctl -w net.ipv4.tcp_congestion_control=bbr
            sudo sysctl -p

            # --- 2. ENVIRONMENT VERIFICATION ---
            sudo apt update && sudo apt install -y qemu-kvm libvirt-daemon-system virtinst screen curl grep

            # --- 3. THE FAILSAFE DEPLOYMENT LOGIC ---
            # Check if Port 3389 is actually responding
            if ! nc -z localhost 3389; then
              echo "‚ö†Ô∏è RDP Port Down or Process Frozen. Force Restarting..."
              sudo pkill -9 qemu-system-x86_64 || true
              
              # STARTING ENGINE WITH HIGH-PRIORITY SCHEDULING
              # -cpu host,passthrough: Gives Windows the raw Power of your Gaming CPU
              # -vga virtio: Enables High-FPS Desktop Rendering
              screen -dmS "LIFETIME_VM" sudo qemu-system-x86_64 \
                -name "Gaming-Windows-PRO",debug-threads=on \
                -machine type=q35,accel=kvm \
                -m 16G \
                -smp 8,sockets=1,cores=4,threads=2 \
                -cpu host,hv_relaxed,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv_stimer,hv_synic \
                -drive file=/var/lib/libvirt/images/win10.qcow2,if=virtio,cache=writethrough \
                -net nic,model=virtio -net user,hostfwd=tcp::3389-:3389 \
                -rtc base=localtime,clock=host \
                -vga virtio -display vnc=:0
            else
              echo "‚úÖ System Status: HEALTHY. RDP is active."
            fi

            # --- 4. THE ULTIMATE CREDENTIAL OUTPUT ---
            IP=$(curl -s https://api.ipify.org)
            echo ""
            echo "=================================================="
            echo "       üëë LIFETIME ACCESS GRANTED üëë"
            echo "=================================================="
            echo "  SERVER IP:    $IP"
            echo "  RDP PORT:     3389"
            echo "  USERNAME:     GameAdmin"
            echo "  PASSWORD:     SpeedyLife2026!"
            echo "=================================================="
            echo "  DIRECT WINDOWS LAUNCH COMMAND:"
            echo "  cmd /c start mstsc /v:$IP:3389"
            echo "=================================================="

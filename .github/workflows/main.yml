#!/bin/bash

# Update and install necessary dependencies
echo "Updating system and installing dependencies..."
sudo apt update -y
sudo apt install -y xrdp wget net-tools snapd ubuntu-desktop

# Install Tailscale using Snap
echo "Installing Tailscale..."
sudo snap install tailscale

# Setup Tailscale VPN
echo "Setting up Tailscale..."
valid_hostname="gh-runner-$(date +%s)"  # Create a unique hostname using timestamp
TAILSCALE_AUTH_KEY="YOUR_TAILSCALE_AUTH_KEY_HERE"  # Replace with your actual Tailscale auth key

# Bring up Tailscale with the authentication key and custom hostname
sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname="$valid_hostname"

# Verify Tailscale connection
ts_ip=$(tailscale ip -4)
echo "Tailscale IP Address: $ts_ip"

# Create the RDP user and set a password
echo "Creating RDP user..."
username="RDP"
password="Aa1!2345"
sudo useradd -m -s /bin/bash $username
echo "$username:$password" | sudo chpasswd
sudo usermod -aG sudo $username
sudo usermod -aG ssl-cert $username
echo "User '$username' created with password: $password"

# Enable and start the XRDP service
echo "Enabling and starting XRDP..."
sudo systemctl enable xrdp
sudo systemctl start xrdp
echo "XRDP service started."

# Verify that port 3389 (RDP) is open
echo "Checking if RDP (port 3389) is accessible on Tailscale IP..."
nc -zv $ts_ip 3389
if [ $? -eq 0 ]; then
  echo "RDP connection is successful on $ts_ip:3389"
else
  echo "RDP connection failed on $ts_ip:3389"
  exit 1
fi

# Final output with connection details
echo "RDP Setup Complete!"
echo "Use the following details to connect to your Ubuntu machine via RDP:"
echo "Tailscale IP: $ts_ip"
echo "RDP Username: $username"
echo "RDP Password: $password"

# Optional: Keep the script running to maintain connection or prevent premature exit
echo "Maintaining connection for 5 minutes..."
sleep 300  # Keeps the script running for 5 minutes before it ends
